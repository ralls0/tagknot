rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Definizione dell'ID dell'app, dovrebbe corrispondere a __app_id nel tuo codice
    function appId() {
      return "tagknot-app";
    }

    // Regole per i profili utente
    match /artifacts/{currentAppId}/users/{userId}/profile/data {
      allow read: if request.auth != null; // Tutti gli utenti autenticati possono leggere i profili
      allow write: if request.auth != null && request.auth.uid == userId; // Solo l'utente proprietario può scrivere il proprio profilo
    }

    // Regole per gli eventi privati degli utenti
    match /artifacts/{currentAppId}/users/{userId}/events/{eventId} {
      allow read: if request.auth != null && request.auth.uid == userId; // Solo l'utente proprietario può leggere i propri eventi
      allow write: if request.auth != null && request.auth.uid == userId; // Solo l'utente proprietario può scrivere i propri eventi
      allow update: if request.auth != null && request.auth.uid == userId; // Solo l'utente proprietario può aggiornare i propri eventi
      allow delete: if request.auth != null && request.auth.uid == userId; // Solo l'utente proprietario può eliminare i propri eventi
    }

    // Regole per i knot privati degli utenti
    match /artifacts/{currentAppId}/users/{userId}/knots/{knotId} {
      allow read: if request.auth != null && request.auth.uid == userId; // Solo l'utente proprietario può leggere i propri knot
      allow write: if request.auth != null && request.auth.uid == userId; // Solo l'utente proprietario può scrivere i propri knot
    }

    // Regole per gli eventi pubblici (accessibili a tutti gli utenti autenticati)
    match /artifacts/{currentAppId}/public/data/events/{eventId} {
      allow read: if request.auth != null; // Tutti gli utenti autenticati possono leggere gli eventi pubblici
      allow create: if request.auth != null && request.resource.data.creatorId == request.auth.uid; // Solo il creatore può creare
      allow update: if request.auth != null && request.resource.data.creatorId == request.auth.uid; // Solo il creatore può aggiornare
      allow delete: if request.auth != null && request.auth.uid == resource.data.creatorId; // Solo il creatore può eliminare
    }

    // Regole per i knot pubblici (accessibili a tutti gli utenti autenticati)
    match /artifacts/{currentAppId}/public/data/knots/{knotId} {
      allow read: if request.auth != null; // Tutti gli utenti autenticati possono leggere i knot pubblici
      allow create: if request.auth != null && request.resource.data.creatorId == request.auth.uid; // Solo il creatore può creare
      allow update: if request.auth != null && request.resource.data.creatorId == request.auth.uid; // Solo il creatore può aggiornare
      allow delete: if request.auth != null && request.auth.uid == resource.data.creatorId; // Solo il creatore può eliminare
    }

    // Regole per i commenti (sotto eventi pubblici)
    match /artifacts/{currentAppId}/public/data/events/{eventId}/comments/{commentId} {
      allow read: if request.auth != null; // Tutti gli utenti autenticati possono leggere i commenti
      allow create: if request.auth != null; // Tutti gli utenti autenticati possono creare commenti
      // Nessuna regola di update/delete per i commenti in questo contesto, ma puoi aggiungerle se necessario
    }

    // Regole per le notifiche
    match /artifacts/{currentAppId}/users/{userId}/notifications/{notificationId} {
      allow read: if request.auth != null && request.auth.uid == userId; // Solo l'utente proprietario può leggere le proprie notifiche
      allow write: if false; // Le notifiche sono create dal sistema, non dagli utenti direttamente
    }
  }
}

// rules_version = '2';
// service cloud.firestore {
//   match /databases/{database}/documents {
//     match /{document=**} {
//       allow read, write: if request.auth != null;
//     }
//   }
// }
